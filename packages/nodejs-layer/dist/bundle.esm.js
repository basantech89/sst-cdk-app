import{Runtime as e,Code as t,LayerVersion as n,Architecture as o}from"aws-cdk-lib/aws-lambda";import*as r from"node:os";import*as i from"node:path";import s from"node:path";import{spawnSync as a}from"node:child_process";import*as l from"node:fs";import c from"node:fs";import*as u from"aws-cdk-lib";function d(e,t=process.cwd()){return p([e],t)[0]}function p(e,t=process.cwd()){const n=i.resolve(t),o=[];for(const n of e){const e=i.join(t,n);l.existsSync(e)&&o.push(e)}if(o.length>0)return o;const{root:r}=i.parse(n);return n===r?[]:p(e,i.dirname(n))}function m(e){try{return require(`${e}/package.json`).version}catch(e){return}}function h(e,t,n){var o,r,s;const a=Object.assign(Object.assign(Object.assign({},null!==(o=t.dependencies)&&void 0!==o?o:{}),null!==(r=t.devDependencies)&&void 0!==r?r:{}),null!==(s=t.peerDependencies)&&void 0!==s?s:{});if(!a[e])return;const l=a[e].match(/file:(.+)/);if(l&&!i.isAbsolute(l[1])){return`file:${i.join(i.dirname(n),l[1])}`}return a[e]}function f(e){const t=g(e),n=["composite","charset","noEmit","tsBuildInfoFile"],o=Object.assign(Object.assign({},t),{incremental:!1,rootDir:"./",outDir:"./"});let r="";return Object.keys(o).sort().forEach((e=>{if(n.includes(e))return;const t=o[e],i="--"+e,s=typeof t;if("boolean"===s)r+=t?i+" ":i+" false ";else if("string"===s)r+=i+" "+t+" ";else{if("object"!==s)throw new Error(`Missing support for compilerOption: [${e}]: { ${s}, ${t}} \n`);Array.isArray(t)&&(r+=i+" "+t.join(",")+" ")}})),r.trim()}function g(e,t){const{extends:n,compilerOptions:o}=require(e),r=Object.assign(Object.assign({},o),null!=t?t:{});return n?g(i.resolve(e.replace(/[^\/]+$/,""),n),r):r}class v{static detect(e){try{const t=m(e);if(t)return{isLocal:!0,version:t};const n=a(e,["--version"]);return 0!==n.status||n.error?void 0:{isLocal:!1,version:n.stdout.toString().trim()}}catch(e){return}}}var w,b,y,k,$;!function(e){e.CJS="cjs",e.ESM="esm"}(w||(w={})),function(e){e.VERBOSE="verbose",e.DEBUG="debug",e.INFO="info",e.WARNING="warning",e.ERROR="error",e.SILENT="silent"}(b||(b={})),function(e){e.DEFAULT="default",e.EXTERNAL="external",e.INLINE="inline",e.BOTH="both"}(y||(y={})),function(e){e.ASCII="ascii",e.UTF8="utf8"}(k||(k={})),function(e){e.NPM="package-lock.json",e.YARN="yarn.lock",e.PNPM="pnpm-lock.yaml"}($||($={}));class j{static fromLockFile(e,t){switch(i.basename(e)){case $.YARN:return new j({lockFile:$.YARN,installCommand:t&&t!==b.INFO?["yarn","install","--no-immutable","--silent"]:["yarn","install","--no-immutable"],runCommand:["yarn","run"]});case $.PNPM:return new j({lockFile:$.PNPM,installCommand:t&&t!==b.INFO?["pnpm","install","--reporter","silent","--config.node-linker=hoisted","--config.package-import-method=clone-or-copy","--no-prefer-frozen-lockfile"]:["pnpm","install","--config.node-linker=hoisted","--config.package-import-method=clone-or-copy","--no-prefer-frozen-lockfile"],runCommand:["pnpm","exec"],argsSeparator:"--"});default:return new j({lockFile:$.NPM,installCommand:t?["npm","ci","--loglevel",t]:["npm","ci"],runCommand:["npx","--no-install"]})}}constructor(e){this.lockFile=e.lockFile,this.installCommand=e.installCommand,this.runCommand=e.runCommand,this.argsSeparator=e.argsSeparator}runBinCommand(e){const[t,...n]=this.runCommand;return["win32"===r.platform()?`${t}.cmd`:t,...n,...this.argsSeparator?[this.argsSeparator]:[],e].join(" ")}}class E{static bundle(e,n){return t.fromAsset(n.projectRoot,{assetHash:n.assetHash,assetHashType:n.assetHash?u.AssetHashType.CUSTOM:u.AssetHashType.OUTPUT,bundling:new E(e,n)})}static clearEsbuildInstallationCache(){this.esbuildInstallation=void 0}static clearTscInstallationCache(){this.tscInstallation=void 0}constructor(t,n){var o,r,s,a,l,c,d,p,m,h,f,g;if(this.props=n,this.packageManager=j.fromLockFile(n.depsLockFilePath,n.logLevel),E.esbuildInstallation=null!==(o=E.esbuildInstallation)&&void 0!==o?o:v.detect("esbuild"),E.tscInstallation=null!==(r=E.tscInstallation)&&void 0!==r?r:v.detect("typescript"),this.projectRoot=n.projectRoot,this.relativeEntryPath=i.relative(this.projectRoot,i.resolve(n.entry)),this.relativeDepsLockFilePath=i.relative(this.projectRoot,i.resolve(n.depsLockFilePath)),this.relativeDepsLockFilePath.includes(".."))throw new Error(`Expected depsLockFilePath: ${n.depsLockFilePath} to be under projectRoot: ${this.projectRoot} (${this.relativeDepsLockFilePath})`);if(n.tsconfig&&(this.relativeTsconfigPath=i.relative(this.projectRoot,i.resolve(n.tsconfig))),n.preCompilation&&!/\.tsx?$/.test(n.entry))throw new Error("preCompilation can only be used with typescript files");if(n.format===w.ESM&&(g=n.runtime,[e.NODEJS,e.NODEJS_4_3,e.NODEJS_6_10,e.NODEJS_8_10,e.NODEJS_10_X,e.NODEJS_12_X].some((e=>e.family===g.family&&e.name===g.name))))throw new Error(`ECMAScript module output format is not supported by the ${n.runtime.name} runtime`);const b=function(t){return[e.NODEJS,e.NODEJS_4_3,e.NODEJS_6_10,e.NODEJS_8_10,e.NODEJS_10_X,e.NODEJS_12_X,e.NODEJS_14_X,e.NODEJS_16_X].some((e=>e.family===t.family&&e.name===t.name))}(n.runtime),y=b?["aws-sdk"]:["@aws-sdk/*"],k=(null===(s=n.runtime)||void 0===s?void 0:s.isVariable)||n.bundleAwsSDK?[]:y,$=null!==(a=n.externalModules)&&void 0!==a?a:k;$.length&&b&&u.Annotations.of(t).addWarningV2("aws-cdk-lib/aws-lambda-nodejs:runtimeUpdateSdkV2Breakage","Be aware that the NodeJS runtime of Node 16 will be deprecated by Lambda on June 12, 2024. Lambda runtimes Node 18 and higher include SDKv3 and not SDKv2. Updating your Lambda runtime will require bundling the SDK, or updating all SDK calls in your handler code to use SDKv3 (which is not a trivial update). Please account for this added complexity and update as soon as possible."),b&&$.some((e=>e.startsWith("@aws-sdk/")))?u.Annotations.of(t).addWarningV2("@aws-cdk/aws-lambda-nodejs:sdkV3NotInRuntime","If you are relying on AWS SDK v3 to be present in the Lambda environment already, please explicitly configure a NodeJS runtime of Node 18 or higher."):!b&&$.includes("aws-sdk")&&u.Annotations.of(t).addWarningV2("@aws-cdk/aws-lambda-nodejs:sdkV2NotInRuntime","If you are relying on AWS SDK v2 to be present in the Lambda environment already, please explicitly configure a NodeJS runtime of Node 16 or lower."),$.length&&(null===(l=n.runtime)||void 0===l?void 0:l.isVariable)&&u.Annotations.of(t).addWarningV2("@aws-cdk/aws-lambda-nodejs:variableRuntimeExternals","When using NODEJS_LATEST the runtime version may change as new runtimes are released, this may affect the availability of packages shipped with the environment. Ensure that any external dependencies are available through layers or specify a specific runtime version."),this.externals=[...$,...null!==(c=n.nodeModules)&&void 0!==c?c:[]];const S=n.forceDockerBundling||!E.esbuildInstallation;this.image=S?null!==(d=n.dockerImage)&&void 0!==d?d:u.DockerImage.fromBuild(i.join(__dirname,"..","lib"),{buildArgs:Object.assign(Object.assign({},null!==(p=n.buildArgs)&&void 0!==p?p:{}),{IMAGE:n.runtime.bundlingImage.image,ESBUILD_VERSION:null!==(m=n.esbuildVersion)&&void 0!==m?m:"0"}),platform:n.architecture.dockerPlatform}):u.DockerImage.fromRegistry("dummy");const D=this.createBundlingCommand({inputDir:u.AssetStaging.BUNDLING_INPUT_DIR,outputDir:u.AssetStaging.BUNDLING_OUTPUT_DIR,esbuildRunner:"esbuild",tscRunner:"tsc",osPlatform:"linux"});this.command=null!==(h=n.command)&&void 0!==h?h:["bash","-c",D],this.environment=n.environment,this.workingDirectory=null!==(f=n.workingDirectory)&&void 0!==f?f:"/",this.entrypoint=n.entrypoint,this.volumes=n.volumes,this.volumesFrom=n.volumesFrom,this.user=n.user,this.securityOpt=n.securityOpt,this.network=n.network,this.bundlingFileAccess=n.bundlingFileAccess,n.forceDockerBundling||(this.local=this.getLocalBundlingProvider())}createBundlingCommand(e){var t,n,o,s,a,l,c,u,p,g,v,b,k,j;const E=(P=e.osPlatform,function(...e){const t=i.join(...e);return"win32"===r.platform()&&"win32"!==P?t.replace(/\\/g,"/"):t});var P;let x=E(e.inputDir,this.relativeEntryPath),M="";if(this.props.preCompilation){const n=null!==(t=this.props.tsconfig)&&void 0!==t?t:d("tsconfig.json",i.dirname(this.props.entry));if(!n)throw new Error("Cannot find a `tsconfig.json` but `preCompilation` is set to `true`, please specify it via `tsconfig`");const o=f(n);M=`${e.tscRunner} "${x}" ${o}`,x=x.replace(/\.ts(x?)$/,".js$1")}const F=Object.entries(null!==(n=this.props.loader)&&void 0!==n?n:{}),I=Object.entries(null!==(o=this.props.define)&&void 0!==o?o:{});if(!1===this.props.sourceMap&&this.props.sourceMapMode)throw new Error("sourceMapMode cannot be used when sourceMap is false");const R=null!==(s=this.props.sourceMapMode)&&void 0!==s?s:this.props.sourceMap,L=(null!==(a=this.props.sourceMapMode)&&void 0!==a?a:y.DEFAULT)===y.DEFAULT?"":`=${this.props.sourceMapMode}`,C=null===(l=this.props.sourcesContent)||void 0===l||l,_=this.props.format===w.ESM?"math.mjs":"math.js",A=[e.esbuildRunner,"--bundle",`"${x}"`,`--target=${null!==(c=this.props.target)&&void 0!==c?c:N(this.props.runtime)}`,"--platform=node",...this.props.format?[`--format=${this.props.format}`]:[],`--outfile="${E(e.outputDir,"nodejs/node_modules",_)}"`,...this.props.minify?["--minify"]:[],...R?[`--sourcemap${L}`]:[],...C?[]:[`--sources-content=${C}`],...this.externals.map((e=>`--external:${e}`)),...F.map((([e,t])=>`--loader:${e}=${t}`)),...I.map((([e,t])=>`--define:${e}=${JSON.stringify(t)}`)),...this.props.logLevel?[`--log-level=${this.props.logLevel}`]:[],...this.props.keepNames?["--keep-names"]:[],...this.relativeTsconfigPath?[`--tsconfig=${E(e.inputDir,this.relativeTsconfigPath)}`]:[],...this.props.metafile?[`--metafile=${E(e.outputDir,"index.meta.json")}`]:[],...this.props.banner?[`--banner:js=${JSON.stringify(this.props.banner)}`]:[],...this.props.footer?[`--footer:js=${JSON.stringify(this.props.footer)}`]:[],...this.props.mainFields?[`--main-fields=${this.props.mainFields.join(",")}`]:[],...this.props.inject?this.props.inject.map((e=>`--inject:"${e}"`)):[],...this.props.esbuildArgs?[O(this.props.esbuildArgs)]:[]];let J="";if(this.props.nodeModules){const t=d("package.json",i.dirname(this.props.entry));if(!t)throw new Error("Cannot find a `package.json` in this project. Using `nodeModules` requires a `package.json`.");const n=function(e,t){var n;const o={},r=require(e);for(const i of t){const t=null!==(n=h(i,r,e))&&void 0!==n?n:m(i);if(!t)throw new Error(`Cannot extract version for module '${i}'. Check that it's referenced in your package.json or installed.`);o[i]=t}return o}(t,this.props.nodeModules),o=new S(e.osPlatform),r=E(e.inputDir,null!==(u=this.relativeDepsLockFilePath)&&void 0!==u?u:this.packageManager.lockFile),s=this.packageManager.lockFile===$.PNPM;J=D([s?o.write(E(e.outputDir,"pnpm-workspace.yaml"),""):"",o.writeJson(E(e.outputDir,"package.json"),{dependencies:n}),o.copy(r,E(e.outputDir,this.packageManager.lockFile)),o.changeDirectory(e.outputDir),this.packageManager.installCommand.join(" "),s?o.remove(E(e.outputDir,"node_modules",".modules.yaml"),!0):""])}return D([...null!==(g=null===(p=this.props.commandHooks)||void 0===p?void 0:p.beforeBundling(e.inputDir,e.outputDir))&&void 0!==g?g:[],M,A.join(" "),...null!==(b=this.props.nodeModules&&(null===(v=this.props.commandHooks)||void 0===v?void 0:v.beforeInstall(e.inputDir,e.outputDir)))&&void 0!==b?b:[],J,...null!==(j=null===(k=this.props.commandHooks)||void 0===k?void 0:k.afterBundling(e.inputDir,e.outputDir))&&void 0!==j?j:[]])}getLocalBundlingProvider(){var e;const t=r.platform(),n=(e,n,o)=>this.createBundlingCommand({inputDir:this.projectRoot,outputDir:e,esbuildRunner:n.isLocal?this.packageManager.runBinCommand("esbuild"):"esbuild",tscRunner:o&&(o.isLocal?this.packageManager.runBinCommand("tsc"):"tsc"),osPlatform:t}),o=null!==(e=this.props.environment)&&void 0!==e?e:{},i=this.projectRoot;return{tryBundle(e){if(!E.esbuildInstallation)return process.stderr.write("esbuild cannot run locally. Switching to Docker bundling.\n"),!1;if(!E.esbuildInstallation.version.startsWith("0."))throw new Error(`Expected esbuild version 0.x but got ${E.esbuildInstallation.version}`);const r=n(e,E.esbuildInstallation,E.tscInstallation);return function(e,t,n){var o,r;const i=a(e,t,n);if(i.error)throw i.error;if(0!==i.status){if(i.stdout||i.stderr)throw new Error(`[Status ${i.status}] stdout: ${null===(o=i.stdout)||void 0===o?void 0:o.toString().trim()}\n\n\nstderr: ${null===(r=i.stderr)||void 0===r?void 0:r.toString().trim()}`);throw new Error(`${e} ${t.join(" ")} ${(null==n?void 0:n.cwd)?`run in directory ${n.cwd}`:""} exited with status ${i.status}`)}}("win32"===t?"cmd":"bash",["win32"===t?"/c":"-c",r],{env:Object.assign(Object.assign({},process.env),o),stdio:["ignore",process.stderr,"inherit"],cwd:i,windowsVerbatimArguments:"win32"===t}),!0}}}}class S{constructor(e){this.osPlatform=e}write(e,t){return"win32"===this.osPlatform?t?`echo ^${t}^ > "${e}"`:`echo. > "${e}"`:`echo '${t}' > "${e}"`}writeJson(e,t){const n=JSON.stringify(t);return this.write(e,n)}copy(e,t){return"win32"===this.osPlatform?`copy "${e}" "${t}"`:`cp "${e}" "${t}"`}changeDirectory(e){return`cd "${e}"`}remove(e,t=!1){if("win32"===this.osPlatform)return`del "${e}"`;return`rm ${(t?["-f"]:[]).join(" ")} "${e}"`}}function D(e){return e.filter((e=>!!e)).join(" && ")}function N(e){const t=e.name.match(/nodejs(\d+)/);if(!t)throw new Error("Cannot extract version from runtime.");return`node${t[1]}`}function O(e){const t=new Array,n=["--alias","--drop","--pure","--log-override","--out-extension"];for(const[o,r]of Object.entries(e))!0===r||""===r?t.push(o):n.includes(o)?t.push(`${o}:"${r}"`):r&&t.push(`${o}="${r}"`);return t.join(" ")}class P extends n{constructor(t,n,r){var i,a;const l=s.resolve(function(e,t){if(t){if(!/\.(jsx?|tsx?|cjs|cts|mjs|mts)$/.test(t))throw new Error("Only JavaScript or TypeScript entry files are supported.");if(!c.existsSync(t))throw new Error(`Cannot find entry file at ${t}`);return t}const n=function(){let e;const t=function(){var e;const t=Error.prepareStackTrace;Error.prepareStackTrace=(e,t)=>t;const n=null===(e=(new Error).stack)||void 0===e?void 0:e.slice(1);return Error.prepareStackTrace=t,n}();for(const[n,o]of t.entries())if("NodejsFunction"===o.getFunctionName()){e=n+1;break}if(!e||!t[e])throw new Error("Cannot find defining file.");return t[e].getFileName()}(),o=s.extname(n),r=n.replace(new RegExp(`${o}$`),`.${e}.ts`);if(c.existsSync(r))return r;const i=n.replace(new RegExp(`${o}$`),`.${e}.js`);if(c.existsSync(i))return i;const a=n.replace(new RegExp(`${o}$`),`.${e}.mjs`);if(c.existsSync(a))return a;const l=n.replace(new RegExp(`${o}$`),`.${e}.mts`);if(c.existsSync(l))return l;const u=n.replace(new RegExp(`${o}$`),`.${e}.cts`);if(c.existsSync(u))return u;const d=n.replace(new RegExp(`${o}$`),`.${e}.cjs`);if(c.existsSync(d))return d;throw new Error(`Cannot find handler file ${r}, ${i}, ${a}, ${l}, ${u} or ${d}`)}(n,r.entry)),u=o.X86_64,d=function(e){if(e){if(!c.existsSync(e))throw new Error(`Lock file at ${e} doesn't exist`);if(!c.statSync(e).isFile())throw new Error("`depsLockFilePath` should point to a file");return s.resolve(e)}const t=p([$.PNPM,$.YARN,$.NPM]);if(0===t.length)throw new Error("Cannot find a package lock file (`pnpm-lock.yaml`, `yarn.lock` or `package-lock.json`). Please specify it with `depsLockFilePath`.");if(t.length>1)throw new Error(`Multiple package lock files found: ${t.join(", ")}. Please specify the desired one with \`depsLockFilePath\`.`);return t[0]}(r.depsLockFilePath),m=null!==(i=r.projectRoot)&&void 0!==i?i:s.dirname(d),h=e.NODEJS_20_X;super(t,n,Object.assign(Object.assign({},r),{code:E.bundle(t,Object.assign(Object.assign({},null!==(a=r.bundling)&&void 0!==a?a:{}),{entry:l,runtime:h,architecture:u,depsLockFilePath:d,projectRoot:m}))}))}}export{P as NodejsLayer};
